Fixes from Tomas Kalibera (sometimes with slight tweaks).

