Fixes from Tomas Kalibera (sometimes with slight tweaks).

Lots have to do with lack of correct protection.


