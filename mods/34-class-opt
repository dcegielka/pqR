Improvements to S4 code.  Note that other improvements are in 33-kalibera-opt.
