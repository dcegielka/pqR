Speed up reading a character at a time from files.

Fixes a bug in a check for malloc failing when allocting a buffer.
